name: Mobile Release

on:
  push:
    tags:
      - 'mobile-v*'
  workflow_dispatch:
    inputs:
      build_number:
        description: 'Build number override'
        required: false
        type: string

defaults:
  run:
    working-directory: cybervpn_mobile

jobs:
  build-android-release:
    name: Build Android Release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - uses: subosito/flutter-action@v2
        with:
          channel: beta
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Decode keystore
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEY_PROPERTIES: ${{ secrets.ANDROID_KEY_PROPERTIES }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > android/app/upload-keystore.jks
          echo "$ANDROID_KEY_PROPERTIES" > android/key.properties

      - name: Validate certificate pinning configuration
        env:
          CERT_FINGERPRINTS: ${{ secrets.CERT_FINGERPRINTS }}
        run: |
          if [ -z "$CERT_FINGERPRINTS" ]; then
            echo "::error::CERT_FINGERPRINTS secret is empty. Production builds require certificate pinning."
            exit 1
          fi
          count=$(echo "$CERT_FINGERPRINTS" | tr ',' '\n' | grep -c '[^ ]')
          if [ "$count" -lt 2 ]; then
            echo "::warning::Only $count certificate fingerprint(s) configured. Recommended: at least 2 (primary + backup)."
          fi
          echo "Certificate pinning configured with $count fingerprint(s)."

      - name: Build AAB
        env:
          BUILD_NUMBER: ${{ inputs.build_number || github.run_number }}
          CERT_FINGERPRINTS: ${{ secrets.CERT_FINGERPRINTS }}
          SENTRY_DSN: ${{ secrets.MOBILE_SENTRY_DSN }}
        run: |
          flutter build appbundle \
            --release \
            --build-number="$BUILD_NUMBER" \
            --dart-define=API_ENV=prod \
            --dart-define=API_BASE_URL=https://api.cybervpn.com \
            --dart-define=CERT_FINGERPRINTS="$CERT_FINGERPRINTS" \
            --dart-define=SENTRY_DSN="$SENTRY_DSN"

      - name: Upload AAB
        uses: actions/upload-artifact@v4
        with:
          name: android-release-aab
          path: cybervpn_mobile/build/app/outputs/bundle/release/app-release.aab
          retention-days: 90

      - name: Build APK
        env:
          BUILD_NUMBER: ${{ inputs.build_number || github.run_number }}
          CERT_FINGERPRINTS: ${{ secrets.CERT_FINGERPRINTS }}
          SENTRY_DSN: ${{ secrets.MOBILE_SENTRY_DSN }}
        run: |
          flutter build apk \
            --release \
            --build-number="$BUILD_NUMBER" \
            --dart-define=API_ENV=prod \
            --dart-define=API_BASE_URL=https://api.cybervpn.com \
            --dart-define=CERT_FINGERPRINTS="$CERT_FINGERPRINTS" \
            --dart-define=SENTRY_DSN="$SENTRY_DSN"

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: android-release-apk
          path: cybervpn_mobile/build/app/outputs/flutter-apk/app-release.apk
          retention-days: 90

  build-ios-release:
    name: Build iOS Release
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          channel: beta
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Install CocoaPods
        run: cd ios && pod install --repo-update

      - name: Build iOS (no codesign)
        env:
          BUILD_NUMBER: ${{ inputs.build_number || github.run_number }}
          CERT_FINGERPRINTS: ${{ secrets.CERT_FINGERPRINTS }}
          SENTRY_DSN: ${{ secrets.MOBILE_SENTRY_DSN }}
        run: |
          flutter build ios \
            --release \
            --no-codesign \
            --build-number="$BUILD_NUMBER" \
            --dart-define=API_ENV=prod \
            --dart-define=API_BASE_URL=https://api.cybervpn.com \
            --dart-define=CERT_FINGERPRINTS="$CERT_FINGERPRINTS" \
            --dart-define=SENTRY_DSN="$SENTRY_DSN"

      - name: Upload iOS build
        uses: actions/upload-artifact@v4
        with:
          name: ios-release-build
          path: cybervpn_mobile/build/ios/iphoneos/
          retention-days: 90

  test-ios-simulator:
    name: iOS Simulator Tests
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          channel: beta
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Run tests on iOS simulator
        run: flutter test

  deploy-testflight:
    name: Deploy to TestFlight
    runs-on: macos-latest
    needs: [build-ios-release, test-ios-simulator]
    if: startsWith(github.ref, 'refs/tags/mobile-v')
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          channel: beta
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Install CocoaPods
        run: cd ios && pod install --repo-update

      - name: Install Apple certificate and provisioning profile
        env:
          APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_PROVISIONING_PROFILE_BASE64: ${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}
          APPLE_KEYCHAIN_PASSWORD: ${{ secrets.APPLE_KEYCHAIN_PASSWORD }}
        run: |
          CERT_PATH="$RUNNER_TEMP/certificate.p12"
          PP_PATH="$RUNNER_TEMP/profile.mobileprovision"
          KEYCHAIN_PATH="$RUNNER_TEMP/app-signing.keychain-db"

          echo "$APPLE_CERTIFICATE_BASE64" | base64 --decode -o "$CERT_PATH"
          echo "$APPLE_PROVISIONING_PROFILE_BASE64" | base64 --decode -o "$PP_PATH"

          security create-keychain -p "$APPLE_KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$APPLE_KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security import "$CERT_PATH" -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"

          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp "$PP_PATH" ~/Library/MobileDevice/Provisioning\ Profiles

      - name: Build IPA
        env:
          BUILD_NUMBER: ${{ inputs.build_number || github.run_number }}
          CERT_FINGERPRINTS: ${{ secrets.CERT_FINGERPRINTS }}
          SENTRY_DSN: ${{ secrets.MOBILE_SENTRY_DSN }}
        run: |
          flutter build ipa \
            --release \
            --build-number="$BUILD_NUMBER" \
            --dart-define=API_ENV=prod \
            --dart-define=API_BASE_URL=https://api.cybervpn.com \
            --dart-define=CERT_FINGERPRINTS="$CERT_FINGERPRINTS" \
            --dart-define=SENTRY_DSN="$SENTRY_DSN" \
            --export-options-plist=ios/ExportOptions.plist

      - name: Upload to TestFlight
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
        run: |
          API_KEY_PATH="$RUNNER_TEMP/api_key.p8"
          echo "$APP_STORE_CONNECT_API_KEY_BASE64" | base64 --decode -o "$API_KEY_PATH"

          xcrun altool --upload-app \
            --type ios \
            --file build/ios/ipa/*.ipa \
            --apiKey "$APP_STORE_CONNECT_API_KEY_ID" \
            --apiIssuer "$APP_STORE_CONNECT_ISSUER_ID"
