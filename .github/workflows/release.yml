name: Release

on:
  push:
    tags:
      - 'v*.*.*'

# Cancel in-progress runs for the same tag
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    working-directory: cybervpn_mobile

env:
  FLUTTER_VERSION: stable

jobs:
  # ── Determine build metadata from the tag ──────────────────────────────────
  prepare:
    name: Prepare release metadata
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.meta.outputs.version }}
      build_number: ${{ steps.meta.outputs.build_number }}
    steps:
      - name: Extract version from tag
        id: meta
        env:
          TAG_REF: ${{ github.ref }}
        run: |
          TAG="${TAG_REF#refs/tags/v}"
          echo "version=${TAG}" >> "$GITHUB_OUTPUT"
          echo "build_number=${GITHUB_RUN_NUMBER}" >> "$GITHUB_OUTPUT"

  # ── Android: Build AAB and upload to Play Store internal track ─────────────
  release-android:
    name: Android Release (${{ matrix.env }})
    runs-on: ubuntu-latest
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        env: [prod]
        # Uncomment to build all flavors:
        # env: [dev, staging, prod]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Cache pub dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            cybervpn_mobile/.dart_tool
          key: pub-${{ runner.os }}-${{ hashFiles('cybervpn_mobile/pubspec.lock') }}
          restore-keys: |
            pub-${{ runner.os }}-

      - name: Install dependencies
        run: flutter pub get

      - name: Run code generation
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Decode Android keystore
        env:
          KEYSTORE_B64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo "${KEYSTORE_B64}" | base64 --decode > "$RUNNER_TEMP/release-keystore.jks"
          echo "ANDROID_KEYSTORE_PATH=$RUNNER_TEMP/release-keystore.jks" >> "$GITHUB_ENV"

      - name: Build AAB
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          BUILD_NUMBER: ${{ needs.prepare.outputs.build_number }}
          BUILD_ENV: ${{ matrix.env }}
          API_BASE_URL: ${{ secrets.API_BASE_URL }}
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
        run: |
          flutter build appbundle --release \
            --obfuscate \
            --split-debug-info=build/debug-info/ \
            --build-number="${BUILD_NUMBER}" \
            --dart-define=API_ENV="${BUILD_ENV}" \
            --dart-define=API_BASE_URL="${API_BASE_URL:-https://api.cybervpn.com}" \
            --dart-define=SENTRY_DSN="${SENTRY_DSN}"

      - name: Upload Dart debug symbols to Sentry (Android)
        if: secrets.SENTRY_AUTH_TOKEN != ''
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
          VERSION: ${{ needs.prepare.outputs.version }}
          BUILD_NUMBER: ${{ needs.prepare.outputs.build_number }}
        run: |
          curl -sL https://sentry.io/get-cli/ | bash
          sentry-cli upload-dif \
            --org "${SENTRY_ORG}" \
            --project "${SENTRY_PROJECT}" \
            build/debug-info/

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-aab-${{ matrix.env }}
          path: cybervpn_mobile/build/app/outputs/bundle/release/app-release.aab
          retention-days: 30

      - name: Upload debug-info artifact (Android)
        uses: actions/upload-artifact@v4
        with:
          name: android-debug-info-${{ matrix.env }}
          path: cybervpn_mobile/build/debug-info/
          retention-days: 30

      - name: Set up Ruby
        if: matrix.env == 'prod'
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: cybervpn_mobile

      - name: Upload to Play Store (internal track)
        if: matrix.env == 'prod'
        env:
          PLAY_STORE_JSON_KEY: ${{ secrets.PLAY_STORE_JSON_KEY }}
          BUILD_ENV: ${{ matrix.env }}
        run: |
          echo "${PLAY_STORE_JSON_KEY}" > "$RUNNER_TEMP/play-store-key.json"
          export PLAY_STORE_JSON_KEY_PATH="$RUNNER_TEMP/play-store-key.json"
          bundle exec fastlane android android_internal env:"${BUILD_ENV}"

  # ── iOS: Build IPA and upload to TestFlight ────────────────────────────────
  release-ios:
    name: iOS Release (${{ matrix.env }})
    runs-on: macos-latest
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        env: [prod]
        # Uncomment to build all flavors:
        # env: [dev, staging, prod]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Cache pub dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            cybervpn_mobile/.dart_tool
          key: pub-${{ runner.os }}-${{ hashFiles('cybervpn_mobile/pubspec.lock') }}
          restore-keys: |
            pub-${{ runner.os }}-

      - name: Install dependencies
        run: flutter pub get

      - name: Run code generation
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: cybervpn_mobile

      - name: Configure match and Apple credentials
        env:
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
        run: |
          echo "MATCH_GIT_URL=${MATCH_GIT_URL}" >> "$GITHUB_ENV"
          echo "MATCH_PASSWORD=${MATCH_PASSWORD}" >> "$GITHUB_ENV"
          echo "APPLE_TEAM_ID=${APPLE_TEAM_ID}" >> "$GITHUB_ENV"
          echo "APPLE_ID=${APPLE_ID}" >> "$GITHUB_ENV"

      - name: Decode App Store Connect API key
        env:
          API_KEY_JSON: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
        run: |
          echo "${API_KEY_JSON}" > "$RUNNER_TEMP/app-store-connect-key.json"
          echo "APP_STORE_CONNECT_API_KEY_PATH=$RUNNER_TEMP/app-store-connect-key.json" >> "$GITHUB_ENV"

      - name: Build IPA
        env:
          BUILD_NUMBER: ${{ needs.prepare.outputs.build_number }}
          BUILD_ENV: ${{ matrix.env }}
          API_BASE_URL: ${{ secrets.API_BASE_URL }}
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
        run: |
          flutter build ipa --release \
            --obfuscate \
            --split-debug-info=build/debug-info/ \
            --build-number="${BUILD_NUMBER}" \
            --export-options-plist=ios/ExportOptions.plist \
            --dart-define=API_ENV="${BUILD_ENV}" \
            --dart-define=API_BASE_URL="${API_BASE_URL:-https://api.cybervpn.com}" \
            --dart-define=SENTRY_DSN="${SENTRY_DSN}"

      - name: Upload Dart debug symbols to Sentry (iOS)
        if: secrets.SENTRY_AUTH_TOKEN != ''
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
          VERSION: ${{ needs.prepare.outputs.version }}
          BUILD_NUMBER: ${{ needs.prepare.outputs.build_number }}
        run: |
          curl -sL https://sentry.io/get-cli/ | bash
          sentry-cli upload-dif \
            --org "${SENTRY_ORG}" \
            --project "${SENTRY_PROJECT}" \
            build/debug-info/

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa-${{ matrix.env }}
          path: cybervpn_mobile/build/ios/ipa/*.ipa
          retention-days: 30

      - name: Upload debug-info artifact (iOS)
        uses: actions/upload-artifact@v4
        with:
          name: ios-debug-info-${{ matrix.env }}
          path: cybervpn_mobile/build/debug-info/
          retention-days: 30

      - name: Upload to TestFlight
        if: matrix.env == 'prod'
        env:
          BUILD_ENV: ${{ matrix.env }}
        run: |
          bundle exec fastlane ios ios_testflight env:"${BUILD_ENV}"

  # ── Create GitHub Release with artifacts ───────────────────────────────────
  github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [prepare, release-android, release-ios]
    if: always() && needs.prepare.result == 'success'
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          RELEASE_TAG: ${{ github.ref_name }}
          RELEASE_VERSION: ${{ needs.prepare.outputs.version }}
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ needs.prepare.outputs.version }}
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
          generate_release_notes: true
          files: |
            artifacts/**/*.aab
            artifacts/**/*.ipa
