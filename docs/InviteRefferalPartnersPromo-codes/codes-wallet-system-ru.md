# Система кодов и кошелька CyberVPN

Полное описание механизмов: инвайт-коды, реферальные коды, промокоды, партнёрские коды и кошелёк пользователя.

---

## Оглавление

1. [Общая схема](#1-общая-схема)
2. [Инвайт-коды](#2-инвайт-коды)
3. [Реферальные коды](#3-реферальные-коды)
4. [Промокоды](#4-промокоды)
5. [Партнёрские коды](#5-партнёрские-коды)
6. [Кошелёк пользователя](#6-кошелёк-пользователя)
7. [Объединённый Checkout — как всё работает вместе](#7-объединённый-checkout--как-всё-работает-вместе)
8. [Полный сценарий с расчётами](#8-полный-сценарий-с-расчётами)
9. [Настройки админа](#9-настройки-админа)
10. [Граничные случаи](#10-граничные-случаи)

---

## 1. Общая схема

В системе CyberVPN есть **4 типа кодов** и **кошелёк**. Каждый работает независимо, но все могут применяться одновременно при оплате подписки.

```
┌──────────────────────────────────────────────────────────────┐
│                     ПОЛЬЗОВАТЕЛЬ                             │
│                                                              │
│  Реферальный код ─── постоянная ссылка для приглашения       │
│  Инвайт-коды ─────── получает за покупку, дарит друзьям      │
│  Кошелёк (USD) ───── баланс из заработка, тратит на VPN      │
│                                                              │
│  При оплате может ввести:                                    │
│    - Промокод (скидка)                                       │
│    - Списать с кошелька                                      │
│    - Автоматически привязан к партнёру (наценка)             │
└──────────────────────────────────────────────────────────────┘
```

**Ключевой принцип:** Все коды совместимы. Пользователь может одновременно:
- Быть приглашённым по реферальной ссылке
- Быть привязанным к партнёру
- Применить промокод при оплате
- Частично оплатить с кошелька

---

## 2. Инвайт-коды

### Что это
Инвайт-код — это одноразовый код, который даёт **бесплатный VPN на N дней** новому пользователю при регистрации.

### Как получить инвайт-коды

**Способ 1: Автоматически за покупку подписки.**
Админ настраивает правила: какой тариф генерирует сколько инвайтов на какой срок.

**Способ 2: Вручную от админа.**
Админ может выдать любому пользователю инвайт-коды через админ-панель.

### Настройки админа (примеры)

| Тарифный план | Кол-во инвайтов | Срок каждого инвайта |
|---------------|-----------------|---------------------|
| 1 месяц       | 1               | 7 дней              |
| 3 месяца      | 2               | 7 дней              |
| 6 месяцев     | 2               | 14 дней             |
| 12 месяцев    | 3               | 14 дней             |
| Lifetime      | 5               | 30 дней             |

### Пример: Алиса покупает подписку

```
1. Алиса покупает тариф "6 месяцев" за $10
2. Система смотрит правила: "6 месяцев" → 2 инвайта по 14 дней
3. Генерируются 2 кода: "INV-A3KX9F" и "INV-B7MQ2R"
4. Алиса видит их в приложении в разделе "Мои инвайты"
5. Алиса отправляет "INV-A3KX9F" другу Борису
6. Борис скачивает приложение, при регистрации вводит код
7. Борис автоматически получает бесплатный VPN на 14 дней
8. Код "INV-A3KX9F" помечается как использованный — больше никто не может его ввести
```

### Свойства инвайт-кода

- **Одноразовый** — один код = один человек
- **Имеет срок годности** — если не использовать за 30 дней (настраивается), код сгорает
- **Привязан к владельцу** — Алиса видит все свои коды и их статус (использован / свободен / истёк)
- **Регистрация обязательна** — чтобы активировать инвайт, друг должен зарегистрироваться

---

## 3. Реферальные коды

### Что это
У каждого пользователя есть **постоянная уникальная реферальная ссылка**. Когда кто-то регистрируется по этой ссылке и потом покупает подписку — реферер получает **процент от оплаты** на свой кошелёк.

### Отличие от инвайта

| | Инвайт-код | Реферальный код |
|---|---|---|
| Что получает друг | Бесплатный VPN | Ничего (просто регистрируется) |
| Что получает владелец | Ничего | % от каждой оплаты друга |
| Одноразовый? | Да | Нет, постоянный |
| Нужно покупать? | Да (или получить от админа) | Нет, есть у всех |

### Как работает

```
1. У Алисы есть реферальная ссылка: cybervpn.app/ref/ALICE2024
2. Борис переходит по ссылке и регистрируется
3. В системе записывается: "Борис приглашён Алисой"
4. Борис покупает подписку за $10
5. Алиса получает 10% = $1.00 на свой кошелёк
6. Через месяц Борис продлевает подписку за $10
7. Алиса снова получает 10% = $1.00
8. И так далее — пока действует реферальная связь
```

### Режимы длительности реферальной связи

Админ настраивает, как долго реферер получает комиссию с приглашённого:

**Режим 1: Бессрочно**
```
Алиса пригласила Бориса.
Борис платит каждый месяц $10.
Алиса получает $1 каждый месяц. НАВСЕГДА.
```

**Режим 2: Ограничение по времени (например 12 месяцев)**
```
Алиса пригласила Бориса 1 января 2026.
Январь 2026 — Декабрь 2026: Алиса получает 10% с каждого платежа Бориса.
Январь 2027: Реферальная связь истекла. Алиса больше ничего не получает.
```

**Режим 3: Ограничение по количеству оплат (например 5 оплат)**
```
Борис оплачивает подписку:
  Оплата 1: Алиса получает $1.00  ✓
  Оплата 2: Алиса получает $1.00  ✓
  Оплата 3: Алиса получает $1.00  ✓
  Оплата 4: Алиса получает $1.00  ✓
  Оплата 5: Алиса получает $1.00  ✓
  Оплата 6: Лимит исчерпан       ✗ — Алиса больше ничего не получает
```

**Режим 4: Только первая оплата**
```
Борис оплачивает подписку:
  Оплата 1: Алиса получает $1.00  ✓
  Оплата 2: Всё, больше ничего   ✗
```

### Пример расчёта

```
Настройки: комиссия 10%, режим бессрочный

Алиса пригласила 5 человек:
  Борис   — платит $10/мес → Алиса получает $1.00/мес
  Виктор  — платит $5/мес  → Алиса получает $0.50/мес
  Грета   — не купила      → Алиса получает $0.00
  Дима    — платит $20/мес → Алиса получает $2.00/мес
  Елена   — платит $10/мес → Алиса получает $1.00/мес

Итого пассивный доход Алисы: $4.50/мес на кошелёк
```

---

## 4. Промокоды

### Что это
Промокод — скидочный код, который админ создаёт вручную. Пользователь вводит его при оплате и получает скидку.

### Типы скидок

**Процентная скидка:**
```
Промокод: WINTER25
Скидка: 25%
Подписка стоит $10 → со скидкой $7.50
```

**Фиксированная скидка:**
```
Промокод: GIFT3
Скидка: $3
Подписка стоит $10 → со скидкой $7.00
```

### Свойства промокода

| Свойство | Варианты | Пример |
|----------|---------|--------|
| Тип скидки | Процент / Фиксированная сумма | 25% или $3 |
| Использования | Одноразовый / Многоразовый / С лимитом | Макс 100 использований |
| Срок действия | Дата истечения / Бессрочный | До 31.12.2026 |
| Привязка к тарифам | Все тарифы / Конкретные | Только "Pro" и "Ultra" |
| Мин. сумма заказа | Без ограничения / С минимумом | Минимум $5 |

### Примеры промокодов

```
Промокод: NEWYEAR2026
  Тип: 30% скидка
  Использований: до 500
  Срок: до 31.01.2026
  Тарифы: все

Промокод: PROONLY
  Тип: $5 скидка
  Использований: неограничено
  Срок: бессрочный
  Тарифы: только "Pro"
  Мин. сумма: $10

Промокод: VIPGIFT
  Тип: 100% скидка
  Использований: 1 (одноразовый)
  Срок: 7 дней
  Тарифы: только "Basic 1 месяц"
```

### Пример использования

```
1. Админ создаёт промокод "SAVE20" (20%, многоразовый, до 31.03.2026)
2. Борис при оплате вводит "SAVE20"
3. Система проверяет:
   ✓ Код существует
   ✓ Код активен
   ✓ Срок не истёк
   ✓ Лимит использований не превышен
   ✓ Тариф Бориса подходит
4. Подписка $10 → скидка 20% = $2 → к оплате $8
5. Счётчик использований промокода увеличивается на 1
```

---

## 5. Партнёрские коды

### Что это
Партнёр — это реселлер, который продаёт VPN своим клиентам. Партнёр создаёт собственный код, клиент вводит его и **навсегда привязывается к партнёру**. При каждой оплате клиента партнёр зарабатывает.

### Как становятся партнёром

Только админ может назначить статус партнёра пользователю. Обычный пользователь не может стать партнёром самостоятельно.

### Модель заработка партнёра

Партнёр получает деньги из **двух источников**:

**Источник 1: Наценка**
Партнёр устанавливает наценку на базовую цену (от 0% до 300%). Клиент платит дороже, разница идёт партнёру.

**Источник 2: Комиссия от базовой цены**
Админ дополнительно назначает % комиссии от базовой стоимости подписки. Этот процент зависит от количества клиентов партнёра (тиры).

### Тиры комиссий (пример настройки)

| Кол-во клиентов | Комиссия от базовой цены |
|-----------------|-------------------------|
| 0 — 49          | 20%                     |
| 50 — 999        | 30%                     |
| 1000+           | 50%                     |

### Пример: Партнёр Игорь

```
Настройки:
  - Базовая цена тарифа "Pro 1 месяц": $10
  - Наценка Игоря: 100% (цена для клиента = $20)
  - Макс. наценка (лимит): 300%
  - У Игоря 75 клиентов → тир "50-999" → комиссия 30%

Клиент Борис (привязан к Игорю) оплачивает подписку:

  Базовая цена:           $10.00
  + Наценка 100%:         $10.00   → клиент Борис платит $20.00

  Заработок Игоря:
    Наценка:              $10.00   (разница между $20 и $10)
    Комиссия 30% от $10:  $3.00    (админ платит из базовой цены)
    ─────────────────────────────
    Итого Игорю:          $13.00   → зачисляется на кошелёк

  Доход CyberVPN:
    Базовая цена:         $10.00
    - Комиссия Игорю:     -$3.00
    ─────────────────────────────
    Итого CyberVPN:       $7.00
```

### Как клиент привязывается к партнёру

```
1. Игорь (партнёр) создаёт код "IGOR-VPN" с наценкой 100%
2. Борис вводит код "IGOR-VPN" в приложении
3. В профиле Бориса записывается: partner_user_id = Игорь
4. С этого момента ВСЕ оплаты Бориса идут через наценку Игоря
5. Привязка ПОСТОЯННАЯ — Борис не может отвязаться от Игоря
6. Борис видит цену УЖЕ с наценкой (для него это просто "цена подписки")
```

### Партнёрская наценка 0%

Партнёр может установить наценку 0%. В этом случае:
- Клиент платит базовую цену (как без партнёра)
- Партнёр зарабатывает только комиссию от базовой цены
- Используется для "friendly" партнёрства — привлекай клиентов, получай комиссию, не нагружая их наценкой

```
Наценка 0%, 75 клиентов (тир 30%):
  Клиент платит:    $10.00 (базовая)
  Партнёр получает: $3.00  (30% комиссия от базовой)
  CyberVPN:         $7.00
```

### Рост тира

```
Игорь начинает с 0 клиентов:
  Клиент 1-49:    комиссия 20% → заработок = наценка + 20% от базы
  Клиент 50:      ПЕРЕХОД НА НОВЫЙ ТИР → комиссия 30%
  Клиент 50-999:  комиссия 30% → заработок = наценка + 30% от базы
  Клиент 1000:    ПЕРЕХОД НА НОВЫЙ ТИР → комиссия 50%
  Клиент 1000+:   комиссия 50% → заработок = наценка + 50% от базы
```

**Важно:** Тир определяется в момент оплаты клиента по текущему количеству клиентов партнёра. Если партнёр перешёл с 49 на 50 клиентов, следующий платёж уже считается по 30%.

---

## 6. Кошелёк пользователя

### Что это
Каждый пользователь имеет внутренний кошелёк в **USD**. Деньги зачисляются автоматически из реферальных и партнёрских заработков.

### Откуда приходят деньги

| Источник | Пример |
|----------|--------|
| Реферальная комиссия | 10% от оплаты приглашённого |
| Партнёрская наценка | Разница цены |
| Партнёрская комиссия | % от базовой цены |
| Ручное пополнение админом | Бонус, компенсация |

### Куда тратить

| Действие | Описание |
|----------|----------|
| Оплата VPN | Полностью или частично оплатить подписку с баланса |
| Вывод в крипту | Через CryptoBot — перевод USDT/BTC/ETH |

### Пример жизненного цикла кошелька

```
День 1: Алиса пригласила Бориса по реферальной ссылке
  Баланс Алисы: $0.00

День 5: Борис купил подписку за $10, Алиса получает 10%
  +$1.00 (реферальная комиссия)
  Баланс Алисы: $1.00

День 35: Борис продлил подписку за $10
  +$1.00 (реферальная комиссия)
  Баланс Алисы: $2.00

День 40: Алиса пригласила Виктора, тот купил за $20
  +$2.00 (реферальная комиссия)
  Баланс Алисы: $4.00

День 60: Алиса решает оплатить свою подписку ($10) частично с кошелька ($4)
  -$4.00 (оплата подписки)
  Баланс Алисы: $0.00
  К оплате через CryptoBot: $6.00 (остаток)

День 90: Накопилось $15 — Алиса выводит в USDT
  -$15.00 (вывод)
  Баланс Алисы: $0.00
  → $15 приходит на крипто-кошелёк Алисы
```

### Механизм заморозки при оплате

Когда пользователь решает списать деньги с кошелька при оплате подписки:

```
1. Алиса выбирает тариф $10, хочет списать $4 с кошелька
2. Система ЗАМОРАЖИВАЕТ $4 (не списывает, а резервирует)
   Баланс: $4.00 | Заморожено: $4.00 | Доступно: $0.00
3. Создаётся счёт в CryptoBot на $6 (остаток)
4. Алиса оплачивает $6 через крипту

Два варианта:

ВАРИАНТ А: Алиса успешно оплатила $6
  → $4 списываются с кошелька (размораживаются + дебит)
  → Подписка активирована

ВАРИАНТ Б: Алиса не оплатила за 30 минут (таймаут)
  → $4 размораживаются обратно
  → Подписка НЕ активирована
  → Баланс Алисы снова $4.00, ничего не потеряно
```

### Вывод средств

```
1. Алиса запрашивает вывод $15 (метод: CryptoBot)
2. Система проверяет:
   ✓ Баланс >= $15
   ✓ Минимальная сумма вывода = $5 (настройка админа) ✓
   ✓ Выводы разрешены (настройка админа) ✓
3. $15 замораживаются на кошельке
4. Заявка отправляется на одобрение админу
5. Админ видит заявку в панели, проверяет, нажимает "Одобрить"
6. Система отправляет $15 через CryptoBot Transfer API
7. $15 списываются с кошелька, заморозка снимается
8. Статус заявки: "Выполнено"
```

---

## 7. Объединённый Checkout — как всё работает вместе

### Порядок расчёта цены

При оплате подписки система применяет коды и кошелёк в строгом порядке:

```
Шаг 1: Берём БАЗОВУЮ цену тарифа
       ↓
Шаг 2: Применяем ПАРТНЁРСКУЮ НАЦЕНКУ (если клиент привязан к партнёру)
       Формула: базовая × (1 + наценка% / 100)
       ↓
Шаг 3: Применяем ПРОМОКОД (скидка от получившейся цены)
       Формула: цена_после_наценки - скидка
       ↓
Шаг 4: Списываем с КОШЕЛЬКА (сумма, которую выбрал пользователь)
       Формула: цена_после_промо - сумма_с_кошелька
       ↓
Шаг 5: Остаток → оплата через ПЛАТЁЖНЫЙ ШЛЮЗ (CryptoBot)
```

### Откуда считаются комиссии

```
ВАЖНОЕ ПРАВИЛО:

  Реферальная комиссия  = % от БАЗОВОЙ цены тарифа
  Партнёрская комиссия  = % от БАЗОВОЙ цены тарифа
  Партнёрская наценка   = (цена_с_наценкой - базовая)

  Промокод и кошелёк НЕ влияют на комиссии.
  Комиссии всегда считаются от базовой цены.

  Почему? Чтобы предотвратить абьюз: если промокод на 100%,
  реферер и партнёр всё равно получат свои деньги.
```

### Что происходит после успешной оплаты

```
Оплата прошла (webhook от CryptoBot):
  ↓
  1. Активировать VPN подписку (Remnawave API)
  ↓
  2. Сгенерировать инвайт-коды (по правилам тарифа)
  ↓
  3. Начислить реферальную комиссию (если есть реферер)
     → Проверить: не истёк ли срок реферальной связи
     → Зачислить % от базовой цены на кошелёк реферера
  ↓
  4. Начислить партнёрский заработок (если привязан к партнёру)
     → Определить текущий тир по количеству клиентов
     → Наценка + комиссия → на кошелёк партнёра
```

---

## 8. Полный сценарий с расчётами

### Действующие лица

- **Алиса** — обычный пользователь, пригласила Бориса по реферальной ссылке
- **Игорь** — партнёр с наценкой 100%, 75 клиентов (тир 30%)
- **Борис** — пришёл по реферальной ссылке Алисы, привязался к партнёру Игорю

### Настройки системы

```
Тариф "Pro 1 месяц":     базовая цена $10.00
Реферальная комиссия:     10% (бессрочно)
Партнёрские тиры:         0-49 → 20%, 50-999 → 30%, 1000+ → 50%
Инвайты за "Pro 1 месяц": 1 инвайт на 7 дней
```

### Борис оплачивает подписку с промокодом "SAVE20" и $3 с кошелька

**Шаг 1: Базовая цена**
```
Тариф "Pro 1 месяц" = $10.00
```

**Шаг 2: Партнёрская наценка (+100%)**
```
Борис привязан к Игорю (наценка 100%)
$10.00 × (1 + 100/100) = $10.00 × 2 = $20.00

Для Бориса тариф стоит $20.00
```

**Шаг 3: Промокод "SAVE20" (скидка 20%)**
```
$20.00 × 20% = $4.00 (скидка)
$20.00 - $4.00 = $16.00

После промокода: $16.00
```

**Шаг 4: Кошелёк ($3.00)**
```
Борис хочет списать $3 с кошелька
Баланс Бориса: $5.00 → достаточно
$16.00 - $3.00 = $13.00

$3.00 замораживается на кошельке Бориса
```

**Шаг 5: К оплате через CryptoBot**
```
$13.00 → создаётся крипто-счёт
```

**Сводка для Бориса:**
```
┌─────────────────────────────────────┐
│ Тариф: Pro 1 месяц                 │
│                                     │
│ Базовая цена:        $10.00        │
│ Наценка партнёра:    +$10.00       │
│ Цена:                $20.00        │
│ Промокод SAVE20:     -$4.00        │
│ С кошелька:          -$3.00        │
│ ─────────────────────────────       │
│ К оплате:            $13.00        │
└─────────────────────────────────────┘
```

### Борис оплатил $13 — что происходит дальше

**1. Активация VPN**
```
→ Remnawave API: создаётся подписка на 30 дней для Бориса
```

**2. Генерация инвайтов**
```
Правило: "Pro 1 месяц" → 1 инвайт на 7 дней
→ Генерируется код "INV-X7KL3P", владелец Борис
```

**3. Реферальная комиссия для Алисы**
```
Борис приглашён Алисой (referred_by = Алиса)
Режим: бессрочный → проверка пройдена ✓

Комиссия = базовая цена × 10%
         = $10.00 × 10%
         = $1.00

→ +$1.00 на кошелёк Алисы (тип: referral_commission)
```

**4. Партнёрский заработок для Игоря**
```
Борис привязан к Игорю (partner_user_id = Игорь)
У Игоря 75 клиентов → тир 30%

Наценка = цена_с_наценкой - базовая = $20.00 - $10.00 = $10.00
Комиссия = базовая × 30% = $10.00 × 30% = $3.00
Итого = $10.00 + $3.00 = $13.00

→ +$13.00 на кошелёк Игоря (тип: partner_earning)
```

**5. Кошелёк Бориса**
```
$3.00 размораживается и списывается
Было: $5.00 | Стало: $2.00
```

### Итоговое распределение денег

```
Борис заплатил:
  Через CryptoBot:  $13.00
  С кошелька:        $3.00
  ─────────────────────────
  Всего:             $16.00  (после скидки $4)

Куда ушли деньги:
  Алисе (реферал):    $1.00  (10% от базовой $10)
  Игорю (наценка):   $10.00  (разница $20 - $10)
  Игорю (комиссия):   $3.00  (30% от базовой $10)
  CyberVPN:           $6.00  (базовая $10 - комиссия $3 - реферал $1)
  Промокод (скидка):  -$4.00  (промо поглотил часть наценки)
  ─────────────────────────
  Проверка: $1 + $10 + $3 + $6 - $4 = $16 ✓
```

### Более точный расчёт распределения

```
Фактически оплачено: $16.00 ($13 крипта + $3 кошелёк)

Из наценки ($10):
  → $10.00 полностью партнёру Игорю ✓

Из базовой цены ($10):
  → Скидка промокода съедает $4 (из наценённой цены $20,
    но по факту уменьшает сумму, которую клиент платит)
  → Реферал Алисе: $1.00
  → Комиссия Игорю: $3.00
  → CyberVPN забирает: $10 - $1 - $3 = $6.00

Итого получили:
  Алиса:     $1.00
  Игорь:    $13.00  ($10 наценка + $3 комиссия)
  CyberVPN:  $6.00
  Скидка:   -$4.00  (уменьшение того, что заплатил Борис)
  ────────────────
  Сумма:    $16.00 ✓
```

---

## 9. Настройки админа

Все настройки хранятся в таблице `system_config` и управляются через админ-панель.

### Настройки инвайтов

```
invite.plan_rules:
  Правила генерации инвайтов за покупку тарифа.

  Пример:
  ┌──────────────────┬────────────┬───────────┐
  │ Тариф            │ Инвайтов   │ Дней VPN  │
  ├──────────────────┼────────────┼───────────┤
  │ Basic 1 мес      │ 1          │ 3         │
  │ Pro 1 мес        │ 1          │ 7         │
  │ Pro 6 мес        │ 2          │ 14        │
  │ Ultra 12 мес     │ 3          │ 14        │
  │ Lifetime         │ 5          │ 30        │
  └──────────────────┴────────────┴───────────┘

invite.default_expiry_days: 30
  Сколько дней инвайт-код остаётся действительным.
  Если получатель не ввёл код за 30 дней — код сгорает.
```

### Настройки реферальной системы

```
referral.enabled: true / false
  Включена ли реферальная система.

referral.commission_rate: 0.10
  Процент комиссии (0.10 = 10%).

referral.duration_mode:
  "indefinite"           — бессрочно
  "time_limited"         — ограничено по времени
    + months: 12         — 12 месяцев
  "payment_count"        — ограничено по кол-ву оплат
    + count: 5           — первые 5 оплат
  "first_payment_only"   — только первая оплата
```

### Настройки партнёрской системы

```
partner.max_markup_pct: 300
  Максимальная наценка, которую партнёр может установить.
  300 = партнёр может увеличить цену максимум в 4 раза (база + 300%).

partner.base_commission_pct: 10
  Базовая комиссия (для тира по умолчанию).

partner.tiers:
  Тирированная комиссия зависит от количества клиентов:
  ┌─────────────────┬────────────┐
  │ Клиентов        │ Комиссия   │
  ├─────────────────┼────────────┤
  │ 0 — 49          │ 20%        │
  │ 50 — 999        │ 30%        │
  │ 1000+           │ 50%        │
  └─────────────────┴────────────┘
```

### Настройки кошелька

```
wallet.min_withdrawal: $5.00
  Минимальная сумма для вывода.

wallet.withdrawal_enabled: true
  Можно ли выводить деньги.

wallet.withdrawal_fee_pct: 0
  Комиссия за вывод (0 = бесплатно).
  Если поставить 5 — с каждого вывода будет удерживаться 5%.
  Пример: вывод $100, комиссия 5% = $5, на руки $95.
```

---

## 10. Граничные случаи

### Промокод покрывает всю сумму (100% скидка)

```
Тариф: $10
Промокод: FREEVPN (100% скидка)
Кошелёк: не используется

К оплате: $0.00 → CryptoBot НЕ вызывается
Платёж завершается МГНОВЕННО (без ожидания webhook)

НО: комиссии ВСЁ РАВНО начисляются от базовой цены:
  Реферер получает: $10 × 10% = $1.00 ✓
  Партнёр получает: наценка + комиссия ✓
  Инвайты генерируются ✓
```

### Кошелёк + промокод полностью покрывают оплату

```
Тариф: $10, наценка 0%
Промокод: SAVE50 (50% скидка) → $5
Кошелёк: $5

$10 - $5 (промо) - $5 (кошелёк) = $0 → мгновенное завершение
Комиссии считаются от базовых $10.
```

### Партнёр с наценкой 0%

```
Партнёр Игорь, наценка 0%, тир 30%:
  Клиент платит $10 (базовая)
  Наценка: $0
  Комиссия: $10 × 30% = $3
  Игорь получает: $3
  CyberVPN: $7
```

### Пользователь привязан к партнёру И пришёл по реферальной ссылке

```
Алиса пригласила Бориса (реферал).
Борис привязался к партнёру Игорю (партнёрский код).

При оплате Бориса $10 (наценка Игоря 100% → $20):

  Алиса (реферер): $10 × 10% = $1.00 (от базовой)
  Игорь (партнёр): $10 наценка + $3 комиссия = $13.00
  CyberVPN: $10 - $1 - $3 = $6.00

  Обе системы работают параллельно.
  Реферер и партнёр — разные люди, каждый получает своё.
```

### Реферер и партнёр — один и тот же человек

```
Игорь пригласил Бориса по реферальной ссылке.
Борис также привязался к партнёрскому коду Игоря.

При оплате Бориса:
  Игорю как рефереру: $1.00
  Игорю как партнёру: $13.00
  Итого Игорю: $14.00

  Обе комиссии начисляются. Это легальная схема.
```

### Попытка самоприглашения

```
Борис пытается ввести собственный реферальный код при регистрации:
  → Ошибка: "Нельзя использовать собственный реферальный код"

Борис пытается привязаться к собственному партнёрскому коду:
  → Ошибка: "Нельзя привязаться к собственному партнёрскому коду"
```

### Повторная привязка к партнёру

```
Борис уже привязан к партнёру Игорю.
Борис вводит код другого партнёра Сергея.
  → Ошибка 409: "Вы уже привязаны к партнёру. Привязка постоянная."
```

### Промокод для определённых тарифов

```
Промокод "PROONLY" — только для тарифа "Pro"
Борис выбирает тариф "Basic" и вводит "PROONLY"
  → Ошибка: "Промокод не применим к выбранному тарифу"
```

### Истёкший промокод

```
Промокод "NY2026" — срок до 31.01.2026
Борис вводит его 15.02.2026
  → Ошибка: "Срок действия промокода истёк"
```

### Исчерпанный промокод

```
Промокод "LIMITED" — максимум 100 использований, уже использован 100 раз
Борис вводит "LIMITED"
  → Ошибка: "Промокод больше не действует"
```

### Инвайт-код просрочен

```
Алиса получила инвайт 1 января. Срок годности: 30 дней.
Борис вводит код 15 февраля (45 дней прошло).
  → Ошибка: "Инвайт-код просрочен"
```

### Конкурентные операции с кошельком

```
Борис одновременно:
  - Оплачивает подписку ($5 с кошелька) в мобильном приложении
  - Запрашивает вывод $5 в Telegram-боте

Система использует блокировку строки кошелька (SELECT ... FOR UPDATE).
Первая операция заблокирует строку, вторая будет ждать.
Одна из операций успешно пройдёт, вторая получит ошибку
"Недостаточно средств" (если баланс не хватает на обе).
```

---

## Приложение: Схема взаимодействий

```
                          ┌─────────────┐
                          │   АДМИН     │
                          │             │
                          │ Настраивает:│
                          │ • Инвайты   │
                          │ • Рефералы  │
                          │ • Промокоды │
                          │ • Партнёры  │
                          │ • Кошелёк   │
                          └──────┬──────┘
                                 │ конфигурация
                                 ▼
┌──────────┐  реферальная  ┌──────────────┐  привязка  ┌──────────┐
│ РЕФЕРЕР  │──── ссылка ──→│ ПОЛЬЗОВАТЕЛЬ │←── код ────│ ПАРТНЁР  │
│ (Алиса)  │               │   (Борис)    │            │ (Игорь)  │
└────┬─────┘               └──────┬───────┘            └────┬─────┘
     │                            │                         │
     │ получает %                 │ покупает подписку       │ получает
     │ от оплат                   │                         │ наценку +
     │ Бориса                     │ может ввести:           │ комиссию
     │                            │ • промокод              │
     ▼                            │ • списать кошелёк       ▼
┌──────────┐                      │                    ┌──────────┐
│ КОШЕЛЁК  │                      │                    │ КОШЕЛЁК  │
│ Алисы    │                      ▼                    │ Игоря    │
│ +$1.00   │               ┌──────────────┐            │ +$13.00  │
│          │               │  CHECKOUT    │            │          │
│ Тратит:  │               │             │            │ Тратит:  │
│ • VPN    │               │ база $10    │            │ • VPN    │
│ • Вывод  │               │ +наценка    │            │ • Вывод  │
└──────────┘               │ -промо      │            └──────────┘
                           │ -кошелёк    │
                           │ = CryptoBot │
                           └──────┬──────┘
                                  │
                                  ▼
                           ┌──────────────┐
                           │ VPN включён  │
                           │ + инвайты    │
                           │   для Бориса │
                           └──────────────┘
```
