# Система инвайтов "Пригласи друга"

**Дата:** 2026-01-24
**Статус:** Согласовано

---

## Обзор

Система "Пригласи друга" как награда за лояльность. Пользователи с оплаченной подпиской получают инвайты, которые дают друзьям бесплатный доступ. Приглашённые автоматически становятся рефералами — при их оплате владелец инвайта получает бонусы (+7 дней).

### Ключевые особенности

- Админ полностью контролирует правила начисления инвайтов
- Гибкие настройки: какая подписка даёт сколько инвайтов и на какой срок
- Поддержка акций (например, 2x инвайтов в праздники)
- Лимит накопления инвайтов
- Ручная выдача доступа для партнёров, компенсаций, друзей, тестеров
- Интеграция с существующей реферальной системой
- Полный набор уведомлений для всех участников

---

## Основные сущности

```
┌─────────────────────────────────────────────────────────┐
│  INVITE_RULE (правила начисления)                       │
│  - Какая подписка → сколько инвайтов                   │
│  - Срок бесплатного доступа для друга                  │
│  - Скидка для друга при первой оплате                  │
│  - Акции (множитель, период действия)                  │
└─────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────┐
│  INVITE (выданный инвайт)                               │
│  - Владелец (user_id)                                  │
│  - Уникальный код + ссылка                             │
│  - Статус: available / used / expired                  │
│  - Срок бесплатного доступа (из правила)               │
└─────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────┐
│  INVITED_USER (приглашённый друг)                       │
│  - Telegram ID                                         │
│  - Привязка к владельцу инвайта (referrer)             │
│  - Дата окончания бесплатного периода                  │
│  - Статус: active / expired / converted                │
└─────────────────────────────────────────────────────────┘
```

### Лимиты

- Максимум инвайтов на пользователя (настраивается админом)
- Новые инвайты не начисляются при достижении лимита

---

## Админ-панель

### Настройки правил инвайтов

Админ управляет через бота или веб-панель:

**Таблица правил:**

| Подписка | Инвайтов | Срок для друга | Скидка друга |
|----------|----------|----------------|--------------|
| 1 мес    | 0        | —              | —            |
| 3 мес    | 0        | —              | —            |
| 6 мес    | 1        | 14 дней        | 10%          |
| 12 мес   | 1        | 30 дней        | 15%          |

**Глобальные настройки:**

- Лимит накопления инвайтов: `3`
- Срок жизни неиспользованного инвайта: `90 дней` (0 = бессрочно)

**Акции:**

```
Название: "Новогодняя акция"
Множитель: 2x
Период: 25.12.2026 — 10.01.2027
Применяется к: [12 мес, 6 мес]
```

### Ручная выдача доступа

Админ-команда в боте или форма в панели:

```
/grant_access
├─ Telegram: @username или ID
├─ Срок: 30 дней
├─ Тип: [партнёр / компенсация / друг / тест]
├─ Заметка: "Блогер, обзор на YouTube"
├─ Трафик: безлимит / 50GB
├─ Устройств: 3
└─ Ноды: [все / базовые / premium]
```

### Статистика инвайтов

Админ видит:

- Выдано инвайтов за период
- Активировано / не использовано / истекло
- Конверсия в оплату (друг → платящий клиент)
- Топ пользователей по приглашениям

---

## Пользовательский опыт

### Для владельца инвайта

**Получение инвайта (после оплаты):**

```
✅ Оплата прошла успешно!

Ваша подписка: 12 месяцев
Действует до: 24.01.2027

🎁 Вы получили инвайт для друга!
Ваш друг получит 30 дней бесплатного VPN.

📋 Код: INV-A3X9K2
🔗 Ссылка: t.me/YourVPNBot?start=inv_A3X9K2

[Мои инвайты]
```

**Раздел "Мои инвайты" в боте:**

```
🎟 Ваши инвайты (2 из 3)

1. INV-A3X9K2 — доступен
   Срок для друга: 30 дней
   [Копировать код] [Копировать ссылку]

2. INV-B7Y2M4 — использован
   Активировал: @friend_username
   Статус: бесплатный период до 15.02.2026

──────────────────
📊 Статистика:
Приглашено друзей: 3
Из них оплатили: 1
Ваш бонус: +7 дней
```

### Для приглашённого друга

**Активация по ссылке/коду:**

```
👋 Добро пожаловать!

Вас пригласил @owner_username
Вам доступен бесплатный VPN на 30 дней!

[Активировать]
```

**После активации — onboarding:**

```
✅ Доступ активирован до 24.02.2026

Давайте настроим VPN:

📱 Выберите устройство:
[iPhone] [Android] [Windows] [Mac] [Linux]
```

**Напоминание за 3 дня:**

```
⏰ Ваш бесплатный период заканчивается 24.02.2026

Понравился сервис? Оформите подписку со скидкой 15%!

1 мес — 254₽ (было 299₽)
3 мес — 594₽ (было 699₽)

[Оформить со скидкой]
```

---

## Уведомления

### Пользователю (владельцу инвайта)

| Событие | Сообщение |
|---------|-----------|
| Получил инвайт | "🎁 Вы получили инвайт за оплату! Пригласите друга на 30 дней бесплатно" |
| Друг активировал | "👋 Ваш друг @username активировал инвайт и пользуется VPN" |
| Друг оплатил | "🎉 @username оплатил подписку! Вам начислено +7 дней" |
| Напоминание | "🎟 У вас 2 неиспользованных инвайта. Пригласите друзей!" (раз в 2 недели) |
| Инвайт истекает | "⏰ Ваш инвайт INV-A3X9K2 истечёт через 7 дней" |

### Приглашённому другу

| Событие | Сообщение |
|---------|-----------|
| Активация | "✅ Добро пожаловать! Бесплатный доступ до 24.02.2026" |
| Onboarding (день 1) | "📱 Как подключить VPN: выберите устройство..." |
| Onboarding (день 3) | "💡 Совет: используйте локацию Люксембург для лучшей скорости" |
| За 3 дня до конца | "⏰ Осталось 3 дня. Оформите подписку со скидкой 15%!" |
| Последний день | "⚠️ Завтра доступ закончится. Скидка 15% ещё действует!" |
| Доступ закончился | "❌ Бесплатный период завершён. Оформите подписку: [ссылка]" |

### Админу

| Событие | Сообщение |
|---------|-----------|
| Ежедневный отчёт | "📊 Инвайты за сутки: выдано 12, активировано 5, конверсия 2" |
| Недельный отчёт | "📈 Статистика инвайтов за неделю: ..." |

---

## Структура данных

### Таблицы БД

**invite_rules** — правила начисления:

```sql
id              SERIAL PRIMARY KEY
subscription_id INTEGER REFERENCES subscriptions(id)
invites_count   INTEGER DEFAULT 0        -- сколько инвайтов даёт
friend_days     INTEGER DEFAULT 30       -- дней для друга
friend_discount INTEGER DEFAULT 0        -- скидка % для друга
is_active       BOOLEAN DEFAULT true
created_at      TIMESTAMP
updated_at      TIMESTAMP
```

**invite_settings** — глобальные настройки:

```sql
key             VARCHAR PRIMARY KEY
value           JSONB
-- Примеры:
-- max_invites_per_user: 3
-- invite_expiry_days: 90
-- reminder_interval_days: 14
```

**invite_promotions** — акции:

```sql
id              SERIAL PRIMARY KEY
name            VARCHAR(255)
multiplier      DECIMAL(3,1) DEFAULT 1.0  -- 2.0 = двойные инвайты
start_date      TIMESTAMP
end_date        TIMESTAMP
subscription_ids INTEGER[]                -- к каким подпискам применяется
is_active       BOOLEAN DEFAULT true
```

**invites** — выданные инвайты:

```sql
id              SERIAL PRIMARY KEY
owner_id        INTEGER REFERENCES users(id)
code            VARCHAR(20) UNIQUE        -- INV-A3X9K2
friend_days     INTEGER                   -- срок для друга (на момент выдачи)
friend_discount INTEGER                   -- скидка для друга
status          VARCHAR(20) DEFAULT 'available'  -- available/used/expired
used_by         INTEGER REFERENCES users(id)
used_at         TIMESTAMP
expires_at      TIMESTAMP                 -- когда сгорит неиспользованный
created_at      TIMESTAMP
```

**manual_access_grants** — ручная выдача:

```sql
id              SERIAL PRIMARY KEY
admin_id        INTEGER REFERENCES admins(id)
user_telegram   VARCHAR(255)              -- @username или ID
days            INTEGER
grant_type      VARCHAR(50)               -- partner/compensation/friend/test
note            TEXT
traffic_limit   BIGINT                    -- NULL = безлимит
device_limit    INTEGER DEFAULT 1
node_access     VARCHAR(20) DEFAULT 'all' -- all/basic/premium
created_at      TIMESTAMP
activated_at    TIMESTAMP
```

---

## Команды бота и API

### Команды пользователя

| Команда | Описание |
|---------|----------|
| `/invites` | Показать мои инвайты и статистику |
| `/invite_link` | Получить ссылку для текущего инвайта |

### Команды админа

| Команда | Описание |
|---------|----------|
| `/grant_access <user> <days>` | Быстрая выдача доступа |
| `/grant_access_full` | Интерактивная выдача с параметрами |
| `/invite_rules` | Управление правилами инвайтов |
| `/invite_promo` | Управление акциями |
| `/invite_stats [period]` | Статистика инвайтов |
| `/invite_settings` | Глобальные настройки |

### API эндпоинты

```
# Правила
GET    /api/admin/invite-rules
POST   /api/admin/invite-rules
PUT    /api/admin/invite-rules/:id
DELETE /api/admin/invite-rules/:id

# Акции
GET    /api/admin/invite-promos
POST   /api/admin/invite-promos
PUT    /api/admin/invite-promos/:id

# Ручная выдача
POST   /api/admin/manual-grant
GET    /api/admin/manual-grants

# Статистика
GET    /api/admin/invite-stats?from=&to=

# Пользовательские
GET    /api/user/invites
POST   /api/invite/activate/:code
```

### Логика начисления инвайтов

```
При успешной оплате:
1. Получить subscription_id
2. Найти invite_rule для этой подписки
3. Проверить активные акции → применить множитель
4. Проверить лимит пользователя (текущие available < max)
5. Создать N инвайтов со статусом available
6. Отправить уведомление пользователю
```

---

## Автоматизация и интеграция

### Cron-задачи

| Задача | Расписание | Действие |
|--------|------------|----------|
| Истечение инвайтов | Ежедневно 00:00 | Пометить expired, уведомить за 7 дней до |
| Напоминание о неиспользованных | Каждые 14 дней | Уведомить пользователей с available инвайтами |
| Окончание бесплатного периода | Ежедневно 10:00 | За 3 дня и за 1 день — напомнить другу |
| Деактивация друзей | Ежедневно 00:00 | Отключить доступ по истечении периода |
| Статистика админу | Ежедневно 09:00 | Отправить отчёт (если включено) |

### Интеграция с существующей системой

```
Оплата (YooKassa/CryptoBot/Stars)
         │
         ▼
┌─────────────────────────┐
│  Существующий обработчик │
│  платежей               │
└─────────────────────────┘
         │
         ▼
┌─────────────────────────┐
│  + Вызов InviteService  │◄── Новый код
│    .grantInvites(user,  │
│     subscription)       │
└─────────────────────────┘

Активация инвайта
         │
         ▼
┌─────────────────────────┐
│  InviteService          │
│  .activateInvite(code,  │
│   friend_telegram)      │
└─────────────────────────┘
         │
         ├─► Создать пользователя (если новый)
         ├─► Привязать как реферала к владельцу
         ├─► Выдать подписку на N дней
         └─► Отправить onboarding
```

### Файлы для создания/изменения

```
Новые файлы:
├─ src/services/inviteService.js     # Основная логика
├─ src/models/invite.js              # Модели БД
├─ src/handlers/inviteHandlers.js    # Команды бота
├─ src/api/inviteRoutes.js           # API эндпоинты
├─ src/cron/inviteCron.js            # Cron-задачи
└─ migrations/xxx_create_invites.js  # Миграции БД

Изменения:
├─ src/handlers/paymentHandler.js    # + вызов grantInvites
├─ src/handlers/startHandler.js      # + обработка ?start=inv_XXX
└─ src/services/referralService.js   # + интеграция с инвайтами
```

---

## Следующие шаги

1. Создать миграции БД
2. Реализовать InviteService
3. Добавить команды бота
4. Интегрировать с обработчиком платежей
5. Добавить API для веб-панели
6. Настроить cron-задачи
7. Тестирование
