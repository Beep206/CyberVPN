# Программа лояльности

**Дата:** 2026-01-24
**Статус:** Согласовано

---

## Обзор

Накопительная система лояльности, награждающая пользователей за непрерывные оплаты. Чем дольше пользователь с сервисом — тем больше бонусов: дополнительные дни, приоритетная поддержка, доступ к эксклюзивным нодам.

### Ключевые особенности

- Бонусные дни за непрерывные оплаты
- 4 уровня: Bronze → Silver → Gold → Platinum
- Grace period для сохранения прогресса
- Ускоренный зачёт для длинных подписок
- Полный контроль админа над настройками
- Визуализация прогресса для пользователя

---

## Уровни лояльности

```
┌─────────────────────────────────────────────────────────┐
│  🥉 BRONZE (старт)                                      │
│  ✓ Базовый доступ                                      │
│  ✓ Значок Bronze в профиле                             │
└─────────────────────────────────────────────────────────┘
           │ 3 месяца подряд
           ▼
┌─────────────────────────────────────────────────────────┐
│  🥈 SILVER (+3 дня)                                     │
│  ✓ Всё от Bronze                                       │
│  ✓ +3 бонусных дня                                     │
│  ✓ Значок Silver                                       │
└─────────────────────────────────────────────────────────┘
           │ 6 месяцев подряд
           ▼
┌─────────────────────────────────────────────────────────┐
│  🥇 GOLD (+7 дней)                                      │
│  ✓ Всё от Silver                                       │
│  ✓ +7 бонусных дней (всего +10)                        │
│  ✓ Приоритетная техподдержка                           │
│  ✓ Значок Gold                                         │
└─────────────────────────────────────────────────────────┘
           │ 12 месяцев подряд
           ▼
┌─────────────────────────────────────────────────────────┐
│  💎 PLATINUM (+14 дней)                                 │
│  ✓ Всё от Gold                                         │
│  ✓ +14 бонусных дней (всего +24)                       │
│  ✓ Ранний доступ к новым локациям                      │
│  ✓ Доступ к premium-нодам                              │
│  ✓ Значок Platinum                                     │
└─────────────────────────────────────────────────────────┘
```

### Таблица уровней

| Уровень | Месяцев | Бонус дней | Всего дней | Привилегии |
|---------|---------|------------|------------|------------|
| Bronze | 0 | 0 | 0 | Базовый доступ |
| Silver | 3 | +3 | +3 | — |
| Gold | 6 | +7 | +10 | Приоритетная поддержка |
| Platinum | 12 | +14 | +24 | Premium-ноды, ранний доступ |

---

## Ключевые механики

### Grace Period

- После окончания подписки у пользователя есть **14 дней** на оплату
- Если оплатил в пределах grace period — серия сохраняется
- Если не оплатил — серия сбрасывается, уровень падает до Bronze
- Напоминания: за 3 дня и за 1 день до конца grace period

### Ускоренный зачёт

Длинные подписки сразу дают соответствующий уровень:

| Подписка | Месяцев к счётчику | Мгновенный уровень |
|----------|-------------------|-------------------|
| 1 месяц | +1 | — |
| 3 месяца | +3 | Silver |
| 6 месяцев | +6 | Gold |
| 12 месяцев | +12 | Platinum |

### Начисление бонусов

Бонусные дни начисляются **при достижении нового уровня**, не каждый месяц:
- Bronze → Silver: +3 дня (один раз)
- Silver → Gold: +7 дней (один раз)
- Gold → Platinum: +14 дней (один раз)

При сбросе серии и повторном достижении — бонусы начисляются снова.

---

## Админ-панель

### Настройки уровней

Админ управляет через бота или панель:

**Редактируемые параметры:**
- Название и иконка уровня
- Количество месяцев для достижения
- Бонусные дни
- Привилегии (JSON)

### Глобальные настройки

| Настройка | По умолчанию | Описание |
|-----------|--------------|----------|
| grace_period_days | 14 | Дней на оплату после окончания подписки |
| subscription_boost | {...} | Маппинг подписок на месяцы |

### Команды админа

| Команда | Описание |
|---------|----------|
| `/loyalty_levels` | Просмотр и редактирование уровней |
| `/loyalty_settings` | Grace period, ускоренный зачёт |
| `/loyalty_stats` | Статистика: сколько на каком уровне |
| `/user_loyalty <id>` | Посмотреть/изменить уровень пользователя |

### Ручное управление

Админ может:
- Повысить/понизить уровень пользователя
- Добавить бонусные дни без изменения уровня
- Сбросить счётчик (при злоупотреблениях)

---

## Пользовательский опыт

### Команда /loyalty

```
🏆 Ваш уровень лояльности

┌──────────────────────────────┐
│  🥈 SILVER                   │
│  С нами 4 месяца             │
└──────────────────────────────┘

Прогресс до Gold:
████████░░░░░░░░ 4/6 мес

📊 Ваши бонусы:
✅ +3 дня получено за Silver
⏳ +7 дней при достижении Gold

🎁 Привилегии Gold:
• Приоритетная техподдержка
• Значок Gold в профиле

До Gold осталось: 2 месяца
```

### После повышения уровня

```
🎉 Поздравляем!

Вы достигли уровня GOLD! 🥇

Ваши новые привилегии:
✅ +7 бонусных дней начислено
✅ Приоритетная техподдержка
✅ Значок Gold в профиле

Спасибо, что с нами уже 6 месяцев!

До Platinum осталось: 6 месяцев
```

### При покупке длинной подписки

```
✅ Оплата прошла успешно!

Ваша подписка: 12 месяцев
Действует до: 26.01.2027

🎁 Бонус за лояльность:
Вы сразу получаете уровень PLATINUM! 💎

Начислено:
✅ +14 бонусных дней
✅ Доступ к premium-нодам
✅ Ранний доступ к новым локациям
✅ Приоритетная техподдержка

Ваша подписка теперь до: 09.02.2027
```

### Напоминание о grace period

```
⚠️ Ваша подписка закончилась

У вас уровень Gold — не потеряйте его!

Оплатите подписку в течение 14 дней,
чтобы сохранить прогресс лояльности.

Осталось: 12 дней

[Продлить подписку]
```

---

## Структура данных

### Таблицы БД

**loyalty_levels** — уровни лояльности:

```sql
id              SERIAL PRIMARY KEY
name            VARCHAR(50) NOT NULL      -- 'bronze', 'silver', 'gold', 'platinum'
display_name    VARCHAR(50) NOT NULL      -- 'Bronze', 'Silver', etc.
icon            VARCHAR(10)               -- '🥉', '🥈', '🥇', '💎'
months_required INTEGER NOT NULL          -- 0, 3, 6, 12
bonus_days      INTEGER NOT NULL DEFAULT 0
privileges      JSONB                     -- {"priority_support": true, "premium_nodes": true}
sort_order      INTEGER NOT NULL
is_active       BOOLEAN DEFAULT true
```

**loyalty_settings** — глобальные настройки:

```sql
key             VARCHAR(100) PRIMARY KEY
value           JSONB NOT NULL
-- grace_period_days: 14
-- subscription_boost: {"6_months": 6, "12_months": 12}
```

**user_loyalty** — прогресс пользователя:

```sql
id                  SERIAL PRIMARY KEY
user_id             INTEGER UNIQUE NOT NULL
current_level_id    INTEGER REFERENCES loyalty_levels(id)
consecutive_months  INTEGER NOT NULL DEFAULT 0
total_months        INTEGER NOT NULL DEFAULT 0
streak_start_date   DATE
last_payment_date   DATE
grace_period_end    DATE
total_bonus_days    INTEGER DEFAULT 0
created_at          TIMESTAMP DEFAULT NOW()
updated_at          TIMESTAMP DEFAULT NOW()
```

**loyalty_history** — история изменений:

```sql
id              SERIAL PRIMARY KEY
user_id         INTEGER NOT NULL
event_type      VARCHAR(50) NOT NULL      -- 'level_up', 'bonus_days', 'streak_reset', 'manual_change'
old_level_id    INTEGER
new_level_id    INTEGER
bonus_days      INTEGER
note            TEXT
created_at      TIMESTAMP DEFAULT NOW()
```

### Индексы

```sql
CREATE INDEX idx_user_loyalty_user ON user_loyalty(user_id);
CREATE INDEX idx_user_loyalty_grace ON user_loyalty(grace_period_end)
    WHERE grace_period_end IS NOT NULL;
CREATE INDEX idx_loyalty_history_user ON loyalty_history(user_id, created_at DESC);
```

---

## Логика и автоматизация

### Логика при оплате

```
Пользователь оплатил подписку
         │
         ▼
┌─────────────────────────────────┐
│ 1. Определить тип подписки     │
│    (1/3/6/12 месяцев)          │
└─────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────┐
│ 2. Проверить grace period      │
│    Если в пределах → серия     │
│    сохраняется                 │
│    Если нет → серия = 0        │
└─────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────┐
│ 3. Добавить месяцы к счётчику  │
│    1 мес → +1                  │
│    6 мес → +6 (ускоренный)     │
│    12 мес → +12                │
└─────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────┐
│ 4. Проверить достижение уровня │
│    consecutive_months >= N?    │
└─────────────────────────────────┘
         │
    ┌────┴────┐
    │ Да      │ Нет
    ▼         ▼
┌─────────┐  (ничего)
│ Повысить│
│ уровень │
│ +бонусы │
│ +уведом.│
└─────────┘
```

### Cron-задачи

| Задача | Расписание | Действие |
|--------|------------|----------|
| Проверка grace period | Ежедневно 00:00 | Сбросить серию у тех, чей grace period истёк |
| Напоминание о grace | Ежедневно 10:00 | За 3 дня и за 1 день до конца grace period |
| Статистика админу | Еженедельно пн 09:00 | Отчёт: новые уровни, потери, конверсия |

---

## Интеграция

### Связь с системой инвайтов

Бонусы лояльности и инвайты работают **независимо**, но дополняют друг друга:

```
Пользователь Platinum + годовая подписка:
├─ +14 бонусных дней (лояльность)
├─ +1 инвайт для друга (инвайт-система)
└─ Итого: подписка 12 мес + 14 дней + возможность пригласить друга
```

### Файлы для создания/изменения

```
Новые файлы:
├─ src/services/loyaltyService.js    # Основная логика
├─ src/models/loyaltyLevel.js        # Модель уровней
├─ src/models/userLoyalty.js         # Прогресс пользователя
├─ src/handlers/loyaltyHandlers.js   # Команды бота
├─ src/cron/loyaltyCron.js           # Автоматизация
└─ migrations/xxx_create_loyalty.js  # Миграции БД

Изменения:
├─ src/handlers/paymentHandler.js    # + вызов loyaltyService
└─ src/services/subscriptionService.js # + начисление бонусных дней
```

---

## Следующие шаги

1. Создать миграции БД
2. Реализовать LoyaltyService
3. Добавить команды бота
4. Интегрировать с обработчиком платежей
5. Настроить cron-задачи
6. Тестирование
